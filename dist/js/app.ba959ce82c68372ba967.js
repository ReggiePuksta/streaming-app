angular.module("myApp",["myApp.controllers","myApp.services","ui.router","ngCookies"]).run(["$rootScope","authService","$state","$cookieStore",function(a,b,c,d){a.$on("$stateChangeError",function(a,b,d,e,f,g){g.unAuthorized&&c.go("/login")}),b.user=d.get("user")}]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/channels"),a.state("login",{url:"/login",templateUrl:"partials/login.html",controller:"LoginController"}).state("channels",{url:"/channels",templateUrl:"partials/channels.view.html",controller:"ChannelsController"}).state("user-player",{url:"/user/:user",templateUrl:"partials/user-player.html",controller:"UserPlayerController"}).state("publisher",{url:"/publisher",templateUrl:"partials/publisher.view.html",controller:"PublisherController",resolve:{user:["authService","$q",function(a,b){return a.user||b.reject({unAuthorized:!0})}]}}).state("register",{url:"/signup",templateUrl:"partials/signup.html",controller:"SignUpController"})}]),angular.module("myApp.controllers",[]),angular.module("myApp.directives",[]),angular.module("myApp").constant("streamUrls",{rtmpUrl:"10.42.0.1:1935",hlsUrl:"10.42.0.1:8089"}),angular.module("myApp").directive("videoPlayer",function(){var a=function(a,b,c){c.type=c.type||"application/vnd.apple.mpegurl";var d={};console.log(a.rtmpHls),a.rtmpHls===!0?(d.source=[{type:"rtmp/mp4",src:a.userUrlPlayerRtmp},{type:"application/vnd.apple.mpegurl",src:a.userUrl}],d.techOrder=["html5","flash"]):(d.source=[{type:"application/vnd.apple.mpegurl",src:a.userUrl}],d.techOrder=["hls","html5","flash"]);var e={techOrder:d.techOrder,controls:!0,preload:"auto",poster:"",autoplay:!0,height:480,width:854};b.attr("id","videos");var f;a.$on("$destroy",function(){void 0!==f&&null!==f&&f.dispose()}),videojs("videos",e,function(){f=this,f.src(d.source)})};return{restrict:"A,E",replace:!0,template:'<video class="video-js vjs-default-skin centerout"></video>',link:a}}),angular.module("myApp.services",["ngResource"]).factory("User",["$resource",function(a){return a("/users")}]).factory("authService",["AUTH_ENDPOINT","LOGOUT_ENDPOINT","$http","$cookieStore",function(a,b,c,d){var e={};return e.login=function(b,f){return c.post(a,{username:b,password:f}).then(function(a,b){return e.user=a.data,d.put("user",e.user),e.user})},e.logout=function(a){return c.post(b).then(function(b){e.user=void 0,d.remove("user"),a()})},e}]).value("AUTH_ENDPOINT","/login").value("LOGOUT_ENDPOINT","/logout"),angular.module("myApp.controllers").controller("LoginController",["$scope","$state","User","$rootScope","authService",function(a,b,c,d,e){a.buttonText="Login",a.login=function(){a.buttonText="Logging in. . .",e.login(a.user.email,a.user.pass).then(function(a){b.go("publisher")},function(b){a.invalidLogin=!0})["finally"](function(){a.buttonText="Login"})}}]),angular.module("myApp.controllers").controller("SignUpController",["$scope","$state","User",function(a,b,c){a.confirmPass=function(){a.pass===a.confPass&&""!==a.pass?a.user.pass=a.pass:a.user.pass=""},a.createUser=function(){a.confirmPass(),c.save(a.user,function(){b.go("login")})}}]),angular.module("myApp.controllers").controller("UserPlayerController",["$scope","$stateParams","User","$rootScope","$cookieStore","$sce","$http","streamUrls",function(a,b,c,d,e,f,g,h){var i=b.user,j="http://"+h.hlsUrl+"/hls/"+i+".m3u8";a.hls=j,a.userUrlPlayerRtmp="rtmp://"+h.rtmpUrl+"/hls/"+i+"_exhi",a.userUrl=f.trustAsResourceUrl(j),g.get("/check_live/"+i).then(function(b,c){b.data.playerOptions&&b.data.playerOptions.rtmpHls&&(a.rtmpHls=b.data.playerOptions.rtmpHls),a.stream_live=b.data.stream_live,"No user"==b.data.err&&(a.noUser=b.data.err)})}]),angular.module("myApp.controllers").controller("ChannelsController",["$scope","$stateParams","User","$rootScope","$cookieStore","authService","$sce","$http","$state",function(a,b,c,d,e,f,g,h,i){if(h.get("/users").then(function(b,c){a.allUsers=b.data}),e.get("user")&&e.get("user").name){a.user=e.get("user").name;a.userTrue=!0,a.logout=function(){f.logout(function(){i.go(i.current,{},{reload:!0})})}}}]),angular.module("myApp.controllers").controller("PublisherController",["$scope","$stateParams","User","$rootScope","$cookieStore","$sce","$http","authService","$state","streamUrls",function(a,b,c,d,e,f,g,h,i,j){var k=e.get("user").name,l="http://"+j.hlsUrl+"/hls/"+k+".m3u8";a.hls=l,a.userUrlPlayerRtmp="rtmp://"+j.rtmpUrl+"/hls/"+k+"_exhi",a.rtmpUrlHost=j.rtmpUrl,a.userUrl=f.trustAsResourceUrl(l),a.options={live:{message:"Loading.."},rtmpHls:{message:"Loading.."}},a.logout=function(){h.logout(function(){i.go("channels")})},a.generateToken=function(){g.put("/token",{}).then(function(b,c){b.data.token&&(a.token=b.data.token)})},a.enableLive=function(){g.put("/enable_live",{}).then(function(b,c){if(b.data.streamLive||b.data.streamLive===!1){var d=b.data.streamLive;a.options.live.button=d?"danger":"warning",a.options.live.message=d?"Streaming is enabled":"Streaming is Dissabled"}})},a.rtmpHlsSwitch=function(){g.put("/rtmp_hls",{}).then(function(b,c){if(console.log(b.data.rtmpHls),b.data.rtmpHls||b.data.rtmpHls===!1){var d=b.data.rtmpHls;a.options.rtmpHls.button=d?"danger":"warning",a.options.rtmpHls.message=d?"RTMP and HLS playback":"HLS only playback"}})},g.get("/stream_data/"+k).then(function(b,c){console.log(b.data),a.data=b.data,b.data.meta&&(a.inputVideo=b.data.meta.video,a.inputAudio=b.data.meta.audio)}),g.get("/users/"+k).then(function(b,c){if(a.user=b.data,b.data.playerOptions.rtmpHls||b.data.playerOptions.rtmpHls===!1){var d=b.data.playerOptions.rtmpHls;a.options.rtmpHls.button=d?"danger":"warning",a.options.rtmpHls.message=d?"RTMP and HLS playback":"HLS only playback"}if(b.data.stream_user_enabled||b.data.stream_user_enabled===!1){var e=b.data.stream_user_enabled;a.options.live.button=e?"danger":"warning",a.options.live.message=e?"Streaming is enabled":"Streaming is Dissabled"}a.stream_live=b.data.stream_live,a.token=b.data.token,b.data.playerOptions&&b.data.playerOptions.rtmpHls&&(a.rtmpHls=b.data.playerOptions.rtmpHls),"No user"==b.data.err&&(a.noUser=b.data.err)})}]);